<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Search Map Selector</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        #container {
            display: flex;
            flex: 1;
            gap: 20px;
            margin-bottom: 20px;
        }
        #map-container {
            flex: 3;
            position: relative;
        }
        #map {
            height: 100%;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        #controls {
            flex: 1;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
        }
        #results-container {
            display: none;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            position: relative;
        }
        h1, h2 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #333;
        }
        h1 {
            font-size: 24px;
        }
        h2 {
            font-size: 20px;
        }
        .control-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: bold;
            color: #555;
        }
        input[type="text"], input[type="number"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #4285F4;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            margin-top: auto;
        }
        button:hover {
            background-color: #3367D6;
        }
        .secondary-button {
            background-color: #34a853;
        }
        .secondary-button:hover {
            background-color: #2d8d45;
        }
        .coordinates {
            margin-top: 10px;
            color: #666;
            font-size: 14px;
        }
        .instructions {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #e9f5ff;
            border-radius: 6px;
            font-size: 14px;
            line-height: 1.5;
        }
        #search-term {
            margin-bottom: 20px;
        }
        .input-with-button {
            display: flex;
            gap: 8px;
        }
        .input-with-button input {
            flex: 1;
        }
        .input-with-button button {
            margin-top: 0;
        }
        .radius-inputs {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .radius-inputs input[type="number"] {
            width: 80px;
        }
        #search-box {
            position: relative;
            z-index: 10;
            width: 100%;
        }
        .location-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }
        .location-buttons button {
            padding: 6px 10px;
            font-size: 12px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 14px;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        #loading-overlay {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.8);
            justify-content: center;
            align-items: center;
            border-radius: 8px;
            z-index: 1000;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error-message {
            color: #d93025;
            background-color: #fce8e6;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            display: none;
        }
        .results-info {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 10px;
            margin-bottom: 10px;
        }
        .results-info select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
        }
        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        .pagination button {
            padding: 5px 10px;
        }
        .pagination-info {
            display: flex;
            align-items: center;
        }
    </style>
</head>
<body>
    <h1>Business Search Map Selector</h1>

    <div class="instructions">
        <p><strong>Instructions:</strong></p>
        <ol>
            <li>Set your location by using your current location, searching for a place, or clicking on the map</li>
            <li>Adjust the radius by dragging the circle, using the slider, or entering a specific value</li>
            <li>Enter your search term (e.g., "coffee shop", "restaurant")</li>
            <li>Click "Search" to find businesses in the selected area</li>
        </ol>
    </div>

    <div id="container">
        <div id="map-container">
            <div id="map"></div>
        </div>

        <div id="controls">
            <div class="control-group">
                <label for="location-search">Location:</label>
                <div class="location-buttons">
                    <button id="current-location-btn">Use Current Location</button>
                </div>
                <div class="input-with-button">
                    <input id="location-search" type="text" placeholder="Search for a location">
                    <button id="search-location-btn">Search</button>
                </div>
            </div>

            <div class="control-group">
                <label for="search-term">Search Term:</label>
                <input type="text" id="search-term" placeholder="e.g., coffee shop, restaurant">
            </div>

            <div class="control-group">
                <label for="radius-slider">Radius:</label>
                <div class="radius-inputs">
                    <input type="number" id="radius-input" min="100" max="50000" step="100" value="1000">
                    <span>meters</span>
                </div>
                <input type="range" id="radius-slider" min="100" max="50000" step="100" value="1000">
            </div>

            <div class="coordinates">
                <div id="lat-lng-display">Click on the map to set location</div>
            </div>

            <div class="error-message" id="error-message"></div>

            <div class="action-buttons">
                <button id="search-button">Search Businesses</button>
                <button id="copy-button">Copy Parameters</button>
            </div>
        </div>
    </div>

    <div id="results-container">
        <div id="loading-overlay">
            <div class="spinner"></div>
        </div>
        <h2>Search Results</h2>
        
        <div class="results-info">
            <div id="results-count">Found 0 businesses</div>
            <div>
                <label for="results-limit">Show:</label>
                <select id="results-limit">
                    <option value="5">5 results</option>
                    <option value="10" selected>10 results</option>
                    <option value="25">25 results</option>
                    <option value="50">50 results</option>
                    <option value="all">All results</option>
                </select>
            </div>
        </div>
        
        <div class="action-buttons">
            <button id="download-csv" class="secondary-button">Download as CSV</button>
            <button id="download-selected-csv" class="secondary-button">Download Visible Results</button>
        </div>
        
        <table id="results-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Address</th>
                    <th>Phone</th>
                    <th>Rating</th>
                    <th>Website</th>
                </tr>
            </thead>
            <tbody id="results-body"></tbody>
        </table>
        
        <div class="pagination">
            <button id="prev-page">&laquo; Previous</button>
            <div class="pagination-info">Page <span id="current-page">1</span> of <span id="total-pages">1</span></div>
            <button id="next-page">Next &raquo;</button>
        </div>
    </div>

    <script>
        let map;
        let marker;
        let circle;
        let currentLat = 37.7749;
        let currentLng = -122.4194;
        let currentRadius = 1000;
        let geocoder;
        let searchBox;
        let allSearchResults = [];
        let currentPage = 1;
        let resultsPerPage = 10;

        function initMap() {
            map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: currentLat, lng: currentLng },
                zoom: 13,
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                mapTypeControl: true,
                streetViewControl: false
            });

            // Initialize geocoder for location search
            geocoder = new google.maps.Geocoder();

            // Set up places autocomplete
            const input = document.getElementById("location-search");
            searchBox = new google.maps.places.Autocomplete(input);
            searchBox.bindTo('bounds', map);

            // Create initial marker and circle
            createMarkerAndCircle(new google.maps.LatLng(currentLat, currentLng));

            // Add click listener to map
            map.addListener("click", (event) => {
                createMarkerAndCircle(event.latLng);
            });

            // Add radius slider listener
            document.getElementById("radius-slider").addEventListener("input", function() {
                currentRadius = parseInt(this.value);
                document.getElementById("radius-input").value = currentRadius;
                if (circle) {
                    circle.setRadius(currentRadius);
                }
            });

            // Add radius input listener
            document.getElementById("radius-input").addEventListener("input", function() {
                const value = parseInt(this.value);
                if (value >= 100 && value <= 50000) {
                    currentRadius = value;
                    document.getElementById("radius-slider").value = currentRadius;
                    if (circle) {
                        circle.setRadius(currentRadius);
                    }
                }
            });

            // Add search location button listener
            document.getElementById("search-location-btn").addEventListener("click", function() {
                const address = document.getElementById("location-search").value;
                searchLocation(address);
            });

            // Add current location button listener
            document.getElementById("current-location-btn").addEventListener("click", function() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const pos = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            };
                            createMarkerAndCircle(new google.maps.LatLng(pos.lat, pos.lng));
                            map.setCenter(pos);
                        },
                        () => {
                            showError("Error: The Geolocation service failed.");
                        }
                    );
                } else {
                    showError("Error: Your browser doesn't support geolocation.");
                }
            });

            // Listen for place selection
            searchBox.addListener("place_changed", function() {
                const place = searchBox.getPlace();
                if (!place.geometry) {
                    showError("No location details available for this selection.");
                    return;
                }

                // If the place has a geometry, set the map view
                if (place.geometry.viewport) {
                    map.fitBounds(place.geometry.viewport);
                } else {
                    map.setCenter(place.geometry.location);
                    map.setZoom(17);
                }

                // Place a marker
                createMarkerAndCircle(place.geometry.location);
            });

            // Add copy button listener
            document.getElementById("copy-button").addEventListener("click", function() {
                copyParametersToClipboard();
            });

            // Add search button listener
            document.getElementById("search-button").addEventListener("click", function() {
                searchBusinesses();
            });

            // Add download CSV button listener
            document.getElementById("download-csv").addEventListener("click", function() {
                downloadAsCSV(allSearchResults);
            });

            // Add download visible results CSV button listener
            document.getElementById("download-selected-csv").addEventListener("click", function() {
                const visibleResults = getVisibleResults();
                downloadAsCSV(visibleResults);
            });

            // Add results limit change listener
            document.getElementById("results-limit").addEventListener("change", function() {
                const value = this.value;
                if (value === "all") {
                    resultsPerPage = allSearchResults.length;
                } else {
                    resultsPerPage = parseInt(value);
                }
                currentPage = 1;
                updateResultsDisplay();
            });

            // Add pagination listeners
            document.getElementById("prev-page").addEventListener("click", function() {
                if (currentPage > 1) {
                    currentPage--;
                    updateResultsDisplay();
                }
            });

            document.getElementById("next-page").addEventListener("click", function() {
                const totalPages = Math.ceil(allSearchResults.length / resultsPerPage);
                if (currentPage < totalPages) {
                    currentPage++;
                    updateResultsDisplay();
                }
            });
        }

        function searchLocation(address) {
            if (!address) return;
            
            geocoder.geocode({ 'address': address }, function(results, status) {
                if (status === 'OK') {
                    map.setCenter(results[0].geometry.location);
                    createMarkerAndCircle(results[0].geometry.location);
                } else {
                    showError('Geocode was not successful for the following reason: ' + status);
                }
            });
        }

        function createMarkerAndCircle(location) {
            // Update coordinates
            currentLat = location.lat();
            currentLng = location.lng();

            // Update display
            document.getElementById("lat-lng-display").textContent =
                `Latitude: ${currentLat.toFixed(6)}, Longitude: ${currentLng.toFixed(6)}`;

            // Remove previous marker and circle
            if (marker) marker.setMap(null);
            if (circle) circle.setMap(null);

            // Create new marker
            marker = new google.maps.Marker({
                position: location,
                map: map,
                draggable: true,
                animation: google.maps.Animation.DROP
            });

            // Create new circle
            circle = new google.maps.Circle({
                map: map,
                radius: currentRadius,
                fillColor: "#4285F4",
                fillOpacity: 0.2,
                strokeColor: "#4285F4",
                strokeOpacity: 0.8,
                strokeWeight: 2,
                editable: true
            });

            // Bind circle to marker
            circle.bindTo('center', marker, 'position');

            // Add marker drag listener
            marker.addListener("dragend", (event) => {
                currentLat = event.latLng.lat();
                currentLng = event.latLng.lng();
                document.getElementById("lat-lng-display").textContent =
                    `Latitude: ${currentLat.toFixed(6)}, Longitude: ${currentLng.toFixed(6)}`;
            });

            // Add circle radius change listener
            google.maps.event.addListener(circle, 'radius_changed', function() {
                currentRadius = Math.round(circle.getRadius());
                document.getElementById("radius-input").value = currentRadius;
                document.getElementById("radius-slider").value = currentRadius;
            });
        }

        function getParameters() {
            const searchTerm = document.getElementById("search-term").value || "business";
            return {
                search_term: searchTerm,
                latitude: currentLat,
                longitude: currentLng,
                radius: currentRadius
            };
        }

        function copyParametersToClipboard() {
            const params = getParameters();
            const paramsString = JSON.stringify(params, null, 2);

            navigator.clipboard.writeText(paramsString)
                .then(() => {
                    alert("Parameters copied to clipboard!");
                })
                .catch(err => {
                    console.error('Failed to copy: ', err);

                    // Fallback - create a temporary text area
                    const textArea = document.createElement("textarea");
                    textArea.value = paramsString;
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        alert("Parameters copied to clipboard!");
                    } catch (err) {
                        console.error('Fallback: Oops, unable to copy', err);
                        alert("Couldn't copy automatically. Please select and copy the text manually:\n\n" + paramsString);
                    }
                    document.body.removeChild(textArea);
                });
        }

        function showError(message) {
            const errorElement = document.getElementById("error-message");
            errorElement.textContent = message;
            errorElement.style.display = "block";
            setTimeout(() => {
                errorElement.style.display = "none";
            }, 5000);
        }

        function searchBusinesses() {
            const params = getParameters();
            
            // Show loading indicator
            document.getElementById("loading-overlay").style.display = "flex";
            document.getElementById("results-container").style.display = "block";
            document.getElementById("results-body").innerHTML = "";
            
            // Reset pagination 
            currentPage = 1;
            
            // In a real implementation, this would be a server endpoint
            // Here we'll simulate the API call and response
            simulateAPICall(params)
                .then(businesses => {
                    allSearchResults = businesses;
                    updateResultsDisplay();
                    document.getElementById("loading-overlay").style.display = "none";
                })
                .catch(error => {
                    showError(`Error: ${error.message}`);
                    document.getElementById("loading-overlay").style.display = "none";
                    document.getElementById("results-count").textContent = "Search failed. Please try again.";
                });
        }

        // This function simulates calling the backend API
        // In a real implementation, this would be an actual fetch to your server
        function simulateAPICall(params) {
            return new Promise((resolve, reject) => {
                // In a real implementation, this would be:
                // fetch('/api/search', {
                //     method: 'POST',
                //     headers: { 'Content-Type': 'application/json' },
                //     body: JSON.stringify(params)
                // })
                // .then(response => response.json())
                
                // For demonstration, we'll create mock data with a variable number of results
                setTimeout(() => {
                    const mockBusinessNames = [
                        "Cafe Sunshine", "Downtown Restaurant", "Corner Bistro", 
                        "Main Street Bakery", "Riverside Diner", "City View Bar",
                        "Ocean Grill", "Mountain Lodge", "Green Valley Cafe", 
                        "Sunset Restaurant", "Morning Brew", "Starlight Cafe",
                        "The Local Spot", "Fresh Bites", "Harbor View", 
                        "Jungle Cafe", "Metro Diner", "Country Kitchen",
                        "Seaside Bakery", "Urban Eatery", "The Cozy Corner",
                        "Golden Spoon", "Blue Plate", "Silver Diner",
                        "Red Door Cafe", "The Green Room", "Yellow Umbrella",
                        "Purple Fig", "Orange Blossom", "Indigo Restaurant"
                    ];
                    
                    // Generate between 5 and 30 results
                    const resultCount = Math.floor(Math.random() * 26) + 5;
                    const mockBusinesses = [];
                    
                    for (let i = 0; i < resultCount; i++) {
                        const nameIndex = i % mockBusinessNames.length;
                        const rating = (Math.random() * 2 + 3).toFixed(1); // Random rating between 3.0 and 5.0
                        const reviewCount = Math.floor(Math.random() * 300) + 50; // Random review count between 50 and 350
                        
                        mockBusinesses.push({
                            name: `${mockBusinessNames[nameIndex]} ${i + 1}`,
                            address: `${100 + i} ${(['Main', 'Oak', 'Pine', 'Maple', 'Cedar'])[i % 5]} St, City, State`,
                            phone: `(123) ${456 + i}-${7890 + i}`,
                            website: `https://example.com/${mockBusinessNames[nameIndex].toLowerCase().replace(/\s+/g, '')}${i}`,
                            rating: rating,
                            total_ratings: reviewCount,
                            is_open_now: Math.random() > 0.3 ? "Yes" : "No", // 70% chance of being open
                            place_id: `place${i}${Math.random().toString(36).substring(7)}`
                        });
                    }
                    
                    resolve(mockBusinesses);
                }, 1500); // Simulate network delay
            });
        }

        function getVisibleResults() {
            if (resultsPerPage >= allSearchResults.length) {
                return allSearchResults;
            }
            
            const startIndex = (currentPage - 1) * resultsPerPage;
            const endIndex = Math.min(startIndex + resultsPerPage, allSearchResults.length);
            return allSearchResults.slice(startIndex, endIndex);
        }

        function updateResultsDisplay() {
            const visibleResults = getVisibleResults();
            const totalResults = allSearchResults.length;
            const totalPages = Math.ceil(totalResults / resultsPerPage);
            
            // Update count display
            document.getElementById("results-count").textContent = `Found ${totalResults} businesses`;
            
            // Update pagination info
            document.getElementById("current-page").textContent = currentPage;
            document.getElementById("total-pages").textContent = totalPages;
            
            // Enable/disable pagination buttons
            document.getElementById("prev-page").disabled = currentPage === 1;
            document.getElementById("next-page").disabled = currentPage === totalPages;
            
            // Update table
            const tbody = document.getElementById("results-body");
            tbody.innerHTML = "";
            
            visibleResults.forEach(business => {
                const row = document.createElement("tr");
                
                // Name cell
                const nameCell = document.createElement("td");
                nameCell.textContent = business.name;
                row.appendChild(nameCell);
                
                // Address cell
                const addressCell = document.createElement("td");
                addressCell.textContent = business.address;
                row.appendChild(addressCell);
                
                // Phone cell
                const phoneCell = document.createElement("td");
                phoneCell.textContent = business.phone;
                row.appendChild(phoneCell);
                
                // Rating cell
                const ratingCell = document.createElement("td");
                if (business.rating !== 'N/A') {
                    ratingCell.textContent = `${business.rating} (${business.total_ratings} reviews)`;
                } else {
                    ratingCell.textContent = 'No ratings';
                }
                row.appendChild(ratingCell);
                
                // Website cell
                const websiteCell = document.createElement("td");
                if (business.website && business.website !== 'N/A') {
                    const link = document.createElement("a");
                    link.href = business.website;
                    link.textContent = "Visit Website";
                    link.target = "_blank";
                    websiteCell.appendChild(link);
                } else {
                    websiteCell.textContent = "N/A";
                }
                row.appendChild(websiteCell);
                
                tbody.appendChild(row);
            });
            
            // Show/hide pagination based on result count
            const paginationDiv = document.querySelector(".pagination");
            if (totalResults <= resultsPerPage || resultsPerPage >= totalResults) {
                paginationDiv.style.display = "none";
            } else {
                paginationDiv.style.display = "flex";
            }
        }

        function downloadAsCSV(resultsToDownload) {
            if (!resultsToDownload || resultsToDownload.length === 0) {
                showError("No results to download");
                return;
            }
            
            // Define the headers and corresponding properties
            const headers = [
                { label: "Name", key: "name" },
                { label: "Address", key: "address" },
                { label: "Phone", key: "phone" },
                { label: "Website", key: "website" },
                { label: "Rating", key: "rating" },
                { label: "Total Ratings", key: "total_ratings" },
                { label: "Is Open Now", key: "is_open_now" },
                { label: "Place ID", key: "place_id" }
            ];
            
            // Create CSV header row
            let csvContent = headers.map(header => `"${header.label}"`).join(",") + "\n";
            
            // Add data rows
            resultsToDownload.forEach(result => {
                const row = headers.map(header => {
                    // Handle cases where the property might not exist
                    const value = result[header.key] !== undefined ? result[header.key] : "";
                    // Escape double quotes and wrap in quotes
                    return `"${String(value).replace(/"/g, '""')}"`;
                });
                csvContent += row.join(",") + "\n";
            });
            
            // Create a blob and download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            const fileName = resultsToDownload.length === allSearchResults.length 
                ? "all-business-results.csv" 
                : `business-results-${resultsToDownload.length}.csv`;
            link.setAttribute("download", fileName);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>

    <!-- Load Google Maps JavaScript API with Places library -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCpAep2dTkm75_bAQ0B3gUGC8M995BZtL0&libraries=places&callback=initMap" async defer></script>
</body>
</html>